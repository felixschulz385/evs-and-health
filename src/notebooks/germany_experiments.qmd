---
title: "EVs and Health: Experiments for Germany"
author: "Felix Schulz"
date: today
format:
  html:
    css: table-captions.scss
toc: true
toc-depth: 5
toc-expand: 4
---

# TODO

**1. Temporal Lag Structure**

* [x] Apply lag structure:
  * Health outcome → **t**
  * BEV adoption → **t-1**
  * Charging infrastructure (PV) → **t-2**
  * Solar radiation (GR) → **t-3**
* [x] Verify: **PV_t-2 = LPV_t-1**

**2. Instrumental Variable Strategy**

* [x] 1st-stage uses **predicted PV** from 0th-stage (not raw PV)

**3. Nonlinear Relationships**

* [x] **0th-stage**: Add quadratic term **gr_by_year²**
* [x] **1st-stage**: Add quadratic term **PV²** using predicted values

**4. Fixed Effects Specification**

* [x] **State × Year** fixed effects

**5. Heterogeneity Analysis**

* [x] Estimate models separately for:
  * **District type**: Rural vs. Urban
  * **Geography**: Western vs. Eastern states
  
**6. Control Variables**

* [x] **GDP per capita (t-1)**
* [x] Include GDP in 1st and 2nd stages
* [ ] Additional controls:
  * Physician density
  * Population age structure

# Introduction

Multi-stage instrumental variables approach using solar radiation as instrument for charging infrastructure, which instruments BEV adoption, predicting health outcomes measured by hospitalization rates.

# Data Loading

```{r}
#| output: false

library(knitr)
opts_knit$set(root.dir = "../../")
library(tidyverse)
library(gganimate)
library(arrow)
library(sf)
library(haven)
library(lfe)
library(texreg)
```

# Data Preparation

```{r}
#| output: false

## BEV Data

bev_data <- read_dta("data/Germany/raw/BEV_health.dta", col_select = c(AGS, year, gr_by_year, BEV_share, LF_PV, pop_total, average_age, GDP_per_capita))

bev_data <- bev_data %>% 
    filter(AGS >= 1000, AGS <= 99999) %>%
    mutate(
        across(c(AGS, year, pop_total, GDP_per_capita), as.integer),
    ) %>%
    rename(
        PV_l1 = LF_PV,
        gr = gr_by_year
    )

## Health Data

patient_data_raw <- read_csv2("data/Germany/raw/23131-01-01-4.csv", skip = 7, locale = locale(encoding = "ISO-8859-1"))

patient_data <- patient_data_raw %>% 
    rename(year = ...1, AGS = ...2, age = ...4) %>%
    select(-...3) %>%
    filter(!str_detect(AGS, "[A-Za-z]")) %>%
    filter(age == "Insgesamt") %>%
    select(
        year, AGS, 
        patients_all = insgesamt,
        patients_resp = `J00-J99 Krankheiten des  Atmungssystems`
    ) %>%
    mutate(
        across(c(year, AGS, starts_with("patients")), as.integer),
    ) %>%
    mutate(
        AGS = case_when(
            AGS == 11 ~ 11000,
            AGS == 2 ~ 2000,
            TRUE ~ AGS
        )
    ) %>%
    filter(AGS >= 1000, AGS <= 99999)

mortality_data_raw <- read_csv2("data/Germany/raw/12613-93-01-4.csv", skip = 6, locale = locale(encoding = "ISO-8859-1"))

mortality_data <- mortality_data_raw %>% 
    rename(year = ...1, AGS = ...2) %>%
    select(-...3) %>%
    filter(!str_detect(AGS, "[A-Za-z]")) %>%
    select(
        year, AGS, 
        deaths_all = Insgesamt,
        deaths_infants = `unter 1 Jahr`
    ) %>%
    mutate(
        across(everything(), as.integer),
    ) %>%
    mutate(
        AGS = case_when(
            AGS == 11 ~ 11000,
            AGS == 2 ~ 2000,
            TRUE ~ AGS
        )
    ) %>%
    filter(AGS >= 1000, AGS <= 99999)

## Geographic Data

map_data <- st_read("data/Germany/raw/vg5000_12-31.gk3.shape.ebenen/vg5000_ebenen_1231/VG5000_KRS.shp") %>%
    mutate(AGS = as.integer(AGS)) %>%
    select(AGS, GEN, BEZ, geometry) %>%
    mutate(
        state = AGS %/% 1000,
        state = case_when(
            state == 1 ~ "Schleswig-Holstein",
            state == 2 ~ "Hamburg",
            state == 3 ~ "Niedersachsen",
            state == 4 ~ "Bremen",
            state == 5 ~ "Nordrhein-Westfalen",
            state == 6 ~ "Hessen",
            state == 7 ~ "Rheinland-Pfalz",
            state == 8 ~ "Baden-Württemberg",
            state == 9 ~ "Bayern",
            state == 10 ~ "Saarland",
            state == 11 ~ "Berlin",
            state == 12 ~ "Brandenburg",
            state == 13 ~ "Mecklenburg-Vorpommern",
            state == 14 ~ "Sachsen",
            state == 15 ~ "Sachsen-Anhalt",
            state == 16 ~ "Thüringen",
            TRUE ~ NA_character_
        ),
        across(c(BEZ, GEN, state), as_factor),
        CITY = (BEZ %in% c("Kreisfreie Stadt", "Stadtkreis")),
        NEU = AGS >= 12000
    )
```

## Data Validation

```{r}
## BEV Data Validation

bev_data %>% select(AGS) %>% n_distinct()

test <- anti_join(bev_data, map_data, by = "AGS")
test %>% select(AGS) %>% distinct()
test %>% pull(BEV_share) %>% is.na() %>% mean()

## Patient Data Validation

patient_data %>% select(AGS) %>% n_distinct()

test <- anti_join(patient_data, map_data, by = "AGS") 
test %>% select(AGS) %>% distinct()
test %>% pull(patients_all) %>% is.na() %>% mean()

## Mortality Data Validation

mortality_data %>% select(AGS) %>% n_distinct()

test <- anti_join(mortality_data, map_data, by = "AGS")
test %>% select(AGS) %>% distinct()
test %>% pull(deaths_all) %>% is.na() %>% mean()
```

```{r}
## Reverse Validation

anti_join(map_data, bev_data, by = "AGS")

anti_join(map_data, patient_data, by = "AGS")

anti_join(map_data, mortality_data, by = "AGS")
```

```{r}
#| eval: false

## Spatial-Temporal Visualization

animation_bev <- inner_join(bev_data, map_data, by = "AGS") %>% 
    drop_na() %>%
    arrange(year, AGS) %>%
    ggplot() + 
        geom_sf(aes(geometry = geometry, fill = BEV_share, group = AGS)) +
        theme_void() +
        scale_fill_viridis_c(
            option = "plasma", 
            transform = scales::transform_asinh()
        ) +
        labs(
            title = 'Year: {frame_time}',
            fill = "BEV Share (%)"
        ) +
        transition_time(year)

animate(animation_bev, width = 800, height = 600, res = 100)
anim_save("outputs/figures/germany_bev_share.gif", width = 800, height = 600, res = 100)

animation_patients <- inner_join(
    patient_data,
    map_data,
    by = "AGS"
    ) %>% 
    left_join(
        bev_data %>% select(AGS, year, pop_total),
        by = c("AGS", "year")
    ) %>%
    mutate(
        patients_all_per_1000 = (patients_all / pop_total) * 1000
    ) %>%
    drop_na() %>%
    ggplot() + 
        geom_sf(aes(geometry = geometry, fill = patients_all_per_1000, group = AGS)) +
        theme_void() +
        scale_fill_viridis_c(
            option = "plasma", 
            transform = scales::transform_asinh()
        ) +
        labs(
            title = 'Year: {frame_time}',
            fill = "Patients\nper 1,000"
        ) +
        transition_time(year)

animate(animation_patients, width = 800, height = 600, res = 100)
anim_save("outputs/figures/germany_patients.gif", width = 800, height = 600, res = 100)
```

::: {#fig-data layout-ncol=2}

![BEV share evolution across German districts](figures/germany_bev_share.gif)

![All-cause hospitalization rates per 1,000 population](figures/germany_patients.gif)

:::

```{r}
#| fig-cap: "Total All-Cause Hospitalizations in Germany by Year"

patient_data %>%
    group_by(year) %>%
    summarise(
        total_patients = sum(patients_all, na.rm = TRUE)
    ) %>%
    ggplot(aes(x = year, y = total_patients)) +
    geom_line() +
    geom_point() +
    labs(
        x = "Year",
        y = "Total Patients"
    ) +
    theme_bw()
```

## Merge and Lag Structure

```{r}
create_lags_leads <- function(data, vars, n_lags = 5, n_leads = 5, group_var = "AGS", order_var = "year") {
    result <- data %>%
        arrange(!!sym(group_var), !!sym(order_var))
    
    for (var in vars) {
        existing_lag <- 0
        base_var <- var
        
        if (grepl("_l[0-9]+$", var)) {
            existing_lag <- as.integer(gsub(".*_l([0-9]+)$", "\\1", var))
            base_var <- gsub("_l[0-9]+$", "", var)
            
            result <- result %>%
                group_by(!!sym(group_var)) %>%
                mutate(!!base_var := lead(!!sym(var), n = existing_lag)) %>%
                ungroup()
        }
        
        var_to_use <- base_var
        
        for (i in 1:n_lags) {
            lag_name <- paste0(var_to_use, "_l", i)
            result <- result %>%
                group_by(!!sym(group_var)) %>%
                mutate(!!lag_name := lag(!!sym(var_to_use), n = i)) %>%
                ungroup()
        }
        
        for (i in 1:n_leads) {
            lead_name <- paste0(var_to_use, "_f", i)
            result <- result %>%
                group_by(!!sym(group_var)) %>%
                mutate(!!lead_name := lead(!!sym(var_to_use), n = i)) %>%
                ungroup()
        }
    }
    
    return(result)
}

merged <- bev_data %>%
    full_join(patient_data, by = c("AGS", "year")) %>%
    full_join(mortality_data, by = c("AGS", "year")) %>%
    left_join(map_data %>% st_drop_geometry(), by = c("AGS")) %>%
    mutate(
        across(starts_with("patients"), ~ (.x / pop_total) * 1000, .names = "{.col}_per_1000"),
        across(starts_with("deaths"), ~ (.x / pop_total) * 1000, .names = "{.col}_per_1000"),
        stateyear = as_factor(paste0(state, "_", year))
    )

merged <- create_lags_leads(
    merged, 
    vars = c("patients_all_per_1000", "patients_resp_per_1000", "deaths_all_per_1000", "deaths_infants_per_1000", "BEV_share", "PV_l1", "gr", "GDP_per_capita"),
    n_lags = 5,
    n_leads = 5,
    group_var = "AGS",
    order_var = "year"
)
```

# Results

## TWFE and 2SLS Estimates

Two-way fixed effects regression and two-stage least squares with instrumental variables.

```{r}
## All-Cause Hospitalizations

twfe_all <- felm(
    patients_all_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

tsls_all <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)
```

```{r}
## Respiratory Disease Hospitalizations

twfe_resp <- felm(
    patients_resp_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

tsls_resp <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)
```

```{r}
#| output: asis

htmlreg(
    list(
        "TWFE" = twfe_all,
        "1st Stage" = tsls_all$stage1,
        "2SLS" = tsls_all,
        "TWFE" = twfe_resp,
        "1st Stage" = tsls_resp$stage1,
        "2SLS" = tsls_resp
    ),
    custom.header = list(
        "All Causes" = 1:3,
        "Respiratory Diseases" = 4:6
    ),
    caption = "Regression Results. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 5
)
```

### Lag Structure Analysis

```{r}
#| output: asis

fs_all_pv <- felm(
    BEV_share_l1 ~ PV | AGS + stateyear + year | 0 | state + year,
    data = merged
)

fs_all_pv_l1 <- felm(
    BEV_share_l1 ~ PV_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

fs_all_pv_l2 <- felm(
    BEV_share_l1 ~ PV_l2 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

fs_all_pv_l3 <- felm(
    BEV_share_l1 ~ PV_l3 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

htmlreg(
    list(
        "(0)" = fs_all_pv,
        "(1)" = fs_all_pv_l1,
        "(2)" = fs_all_pv_l2,
        "(3)" = fs_all_pv_l3
    ),
    custom.header = list(
        "BEV_l1" = 1:4
    ),
    caption = "First Stage Regression: Instrument Strength Across Lag Specifications. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 5
)
```

#### TWFE: Effect Timing

```{r}
#| output: asis

twfe_all_ <- felm(
    patients_all_per_1000 ~ BEV_share | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_all_l1 <- felm(
    patients_all_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_all_l2 <- felm(
    patients_all_per_1000 ~ BEV_share_l2 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_all_l3 <- felm(
    patients_all_per_1000 ~ BEV_share_l3 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_resp_ <- felm(
    patients_resp_per_1000 ~ BEV_share | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_resp_l1 <- felm(
    patients_resp_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_resp_l2 <- felm(
    patients_resp_per_1000 ~ BEV_share_l2 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_resp_l3 <- felm(
    patients_resp_per_1000 ~ BEV_share_l3 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

htmlreg(
    list(
        "(0)" = twfe_all_,
        "(1)" = twfe_all_l1,
        "(2)" = twfe_all_l2,
        "(3)" = twfe_all_l3,
        "(0)" = twfe_resp_,
        "(1)" = twfe_resp_l1,
        "(2)" = twfe_resp_l2,
        "(3)" = twfe_resp_l3
    ),
    custom.header = list(
        "All Causes" = 1:4,
        "Respiratory Diseases" = 5:8
    ),
    caption = "TWFE Estimates: BEV Effect Timing Across Lag Specifications. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 4
)
```

### Pre-COVID Analysis

```{r}
merged_precovid <- merged %>%
    filter(year < 2020)
```

```{r}
twfe_all_pre <- felm(
    patients_all_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged_precovid
)

tsls_all_pre <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged_precovid
)
```

```{r}
twfe_resp_pre <- felm(
    patients_resp_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged_precovid
)

tsls_resp_pre <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged_precovid
)
```

```{r}
#| output: asis

htmlreg(
    list(
        "TWFE" = twfe_all_pre,
        "1st Stage" = tsls_all_pre$stage1,
        "2SLS" = tsls_all_pre,
        "TWFE" = twfe_resp_pre,
        "1st Stage" = tsls_resp_pre$stage1,
        "2SLS" = tsls_resp_pre
    ),
    custom.header = list(
        "All Causes (Pre-COVID)" = 1:3,
        "Respiratory (Pre-COVID)" = 4:6
    ),
    caption = "Pre-COVID Analysis: Regression Results for 2016-2019. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 5
)
```

### Heterogeneity Analysis: Sample Splits

```{r}
#| output: false

signed_log10 <- function(x) {
    sign(x) * log10(abs(x) + 1)
}

signed_log10_inv <- function(x) {
    sign(x) * (10^abs(x) - 1)
}

run_subsample_tsls <- function(data, group_var, outcome_var = "patients_all_per_1000") {
    levels <- data %>% 
        pull(!!sym(group_var)) %>% 
        unique() %>% 
        na.omit()
    
    results <- list()
    
    for (level in levels) {
        subsample <- data %>% filter(!!sym(group_var) == level)
        
        model <- tryCatch({
            felm(
                formula = as.formula(paste0(outcome_var, " ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | AGS + year")),
                data = subsample
            )
        }, error = function(e) NULL)
        
        if (!is.null(model)) {
            coef_val <- coef(model)["`BEV_share_l1(fit)`"]
            se_val <- sqrt(diag(vcov(model)))["`BEV_share_l1(fit)`"]
            n_obs <- nobs(model)
            
            results[[as.character(level)]] <- tibble(
                group = group_var,
                level = as.character(level),
                coefficient = coef_val,
                se = se_val,
                ci_lower = coef_val - 1.96 * se_val,
                ci_upper = coef_val + 1.96 * se_val,
                n_obs = n_obs
            )
        }
    }
    
    bind_rows(results)
}

subsample_results_all_state <- run_subsample_tsls(merged, "state", "patients_all_per_1000")
subsample_results_all_city <- run_subsample_tsls(merged, "CITY", "patients_all_per_1000")
subsample_results_all_neu <- run_subsample_tsls(merged, "NEU", "patients_all_per_1000")

subsample_results_resp_state <- run_subsample_tsls(merged, "state", "patients_resp_per_1000")
subsample_results_resp_city <- run_subsample_tsls(merged, "CITY", "patients_resp_per_1000")
subsample_results_resp_neu <- run_subsample_tsls(merged, "NEU", "patients_resp_per_1000")

subsample_results_all <- bind_rows(
    subsample_results_all_state,
    subsample_results_all_city,
    subsample_results_all_neu
) %>%
    mutate(outcome = "All Causes")

subsample_results_resp <- bind_rows(
    subsample_results_resp_state,
    subsample_results_resp_city,
    subsample_results_resp_neu
) %>%
    mutate(outcome = "Respiratory")

subsample_results <- bind_rows(subsample_results_all, subsample_results_resp)
```

#### Coefficient Plots: By State

```{r}
#| fig-width: 10
#| fig-height: 6

subsample_results %>%
    filter(group == "state") %>%
    mutate(
        level = fct_reorder(level, coefficient),
        outcome = factor(outcome, levels = c("All Causes", "Respiratory")),
        coef_trans = signed_log10(coefficient),
        ci_lower_trans = signed_log10(ci_lower),
        ci_upper_trans = signed_log10(ci_upper)
    ) %>%
    ggplot(aes(x = level, y = coef_trans, color = outcome)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_point(position = position_dodge(width = 0.5), size = 3) +
    geom_errorbar(
        aes(ymin = ci_lower_trans, ymax = ci_upper_trans),
        position = position_dodge(width = 0.5),
        width = 0.3
    ) +
    coord_flip() +
    scale_y_continuous(
        breaks = signed_log10(c(-1000, -100, -10, 0, 10, 100, 1000)),
        labels = function(x) round(signed_log10_inv(x), 0)
    ) +
    labs(
        x = "State",
        y = "Coefficient (signed log scale)",
        color = "Outcome"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        panel.grid.major.y = element_line(color = "gray90"),
        panel.grid.minor = element_blank()
    )
```

#### Coefficient Plots: City vs. Rural

```{r}
#| fig-width: 8
#| fig-height: 4

subsample_results %>%
    filter(group == "CITY") %>%
    mutate(
        level = ifelse(level == "TRUE", "City", "Rural"),
        outcome = factor(outcome, levels = c("All Causes", "Respiratory"))
    ) %>%
    ggplot(aes(x = level, y = coefficient, color = outcome)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_point(position = position_dodge(width = 0.5), size = 4) +
    geom_errorbar(
        aes(ymin = ci_lower, ymax = ci_upper),
        position = position_dodge(width = 0.5),
        width = 0.3,
        linewidth = 1
    ) +
    coord_flip() +
    labs(
        x = "District Type",
        y = "Coefficient",
        color = "Outcome"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        panel.grid.major.y = element_line(color = "gray90"),
        panel.grid.minor = element_blank()
    )
```

#### Coefficient Plots: East vs. West Germany

```{r}
#| fig-width: 6
#| fig-height: 4

subsample_results %>%
    filter(group == "NEU") %>%
    mutate(
        level = ifelse(level == "TRUE", "East", "West"),
        level = fct_reorder(level, coefficient),
        outcome = factor(outcome, levels = c("All Causes", "Respiratory"))
    ) %>%
    ggplot(aes(x = level, y = coefficient, color = outcome)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_point(position = position_dodge(width = 0.5), size = 4) +
    geom_errorbar(
        aes(ymin = ci_lower, ymax = ci_upper),
        position = position_dodge(width = 0.5),
        width = 0.3,
        linewidth = 1
    ) +
    coord_flip() +
    labs(
        x = "",
        y = "Coefficient",
        color = "Outcome"
    ) +
    theme_minimal() +
    theme(
        legend.position = "bottom",
        panel.grid.major.y = element_line(color = "gray90"),
        panel.grid.minor = element_blank()
    )
```

## Multi-Stage IV: Adding 0-th Stage

```{r}
#| output: asis

merged_chain <- merged %>%
    drop_na(
        patients_all_per_1000, patients_resp_per_1000, BEV_share_l1, PV_l1, gr_l2
    )

## 0th Stage: Solar Radiation → Charging Infrastructure

zeroth_stage <- felm(
    PV_l1 ~ gr_l2 | AGS + stateyear + year | 0 | state + year,
    data = merged_chain
)

merged_chain <- merged_chain %>%
    mutate(
        PV_l1_pred = zeroth_stage$fitted.values
    )

## 2SLS Chain

tsls_chain <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred) | state + year,
    data = merged_chain
)

tsls_chain_1quadratic <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred + I(PV_l1_pred^2)) | state + year,
    data = merged_chain
)

tsls_chain_resp <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred) | state + year,
    data = merged_chain
)

tsls_chain_resp_1quadratic <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred + I(PV_l1_pred^2)) | state + year,
    data = merged_chain
)

## 0th Stage with Quadratic

zeroth_stage_0quadratic <- felm(
    PV_l1 ~ gr_l2 + I(gr_l2^2) | AGS + stateyear + year | 0 | state + year,
    data = merged_chain
)

merged_chain <- merged_chain %>%
    mutate(
        PV_l1_pred_0quadratic = zeroth_stage_0quadratic$fitted.values
    )

tsls_chain_0quadratic <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic) | state + year,
    data = merged_chain
)

tsls_chain_0quadratic_1quadratic <- felm(
    patients_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic + I(PV_l1_pred_0quadratic^2)) | state + year,
    data = merged_chain
)

tsls_chain_resp_0quadratic <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic) | state + year,
    data = merged_chain
)

tsls_chain_resp_0quadratic_1quadratic <- felm(
    patients_resp_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic + I(PV_l1_pred_0quadratic^2)) | state + year,
    data = merged_chain
)
```

```{r}
#| output: asis

htmlreg(
    list(
        "(1)" = zeroth_stage,
        "(2)" = zeroth_stage_0quadratic,
        "(1.1.1)" = tsls_chain,
        "(1.1.2)" = tsls_chain_1quadratic,
        "(2.1.1)" = tsls_chain_0quadratic,
        "(2.1.2)" = tsls_chain_0quadratic_1quadratic,
        "(1.2.1)" = tsls_chain_resp,
        "(1.2.2)" = tsls_chain_resp_1quadratic,
        "(2.2.1)" = tsls_chain_resp_0quadratic,
        "(2.2.2)" = tsls_chain_resp_0quadratic_1quadratic
    ),
    custom.header = list(
        "0-th Stage" = 1:2,
        "All Causes 2SLS" = 3:6,
        "Respiratory 2SLS" = 7:10
    ),
    caption = "Multi-Stage IV Results. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    custom.gof.rows = list(
        "Quadratic 0-th Stage" = c("", "✓", "", "", "✓", "✓", "", "", "✓", "✓"),
        "Quadratic 1st Stage" = c("", "", "", "✓", "", "✓", "", "✓", "", "✓")
    ),
    digits = 5,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE
)
```

## Robustness: Additional Control Variables

```{r}
twfe_all_controls <- felm(
    patients_all_per_1000 ~ BEV_share_l1 + average_age + GDP_per_capita_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

twfe_resp_controls <- felm(
    patients_resp_per_1000 ~ BEV_share_l1 + average_age + GDP_per_capita_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

tsls_all_controls <- felm(
    patients_all_per_1000 ~ average_age + GDP_per_capita_l1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)

tsls_resp_controls <- felm(
    patients_resp_per_1000 ~ average_age + GDP_per_capita_l1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)
```

```{r}
#| warning: false
#| output: asis

htmlreg(
    list(
        "TWFE" = twfe_all_controls,
        "2SLS" = tsls_all_controls,
        "TWFE" = twfe_resp_controls,
        "2SLS" = tsls_resp_controls
    ),
    custom.header = list(
        "All Causes" = 1:2,
        "Respiratory Diseases" = 3:4
    ),
    caption = "Robustness: Additional Controls. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    custom.coef.map = list(
        "BEV_share_l1" = "BEV Share (t-1)",
        "`BEV_share_l1(fit)`" = "BEV Share (t-1, instrumented)",
        "average_age" = "Average Age",
        "GDP_per_capita_l1" = "GDP per Capita (t-1)"
    ),
    custom.gof.rows = list(
        "Demographic & Economic Controls" = c("✓", "✓", "✓", "✓")
    ),
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 5
)
```

## Mortality Analysis

```{r}
## All-Cause Mortality

twfe_deaths_all <- felm(
    deaths_all_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

tsls_deaths_all <- felm(
    deaths_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)

## Infant Mortality

twfe_deaths_infants <- felm(
    deaths_infants_per_1000 ~ BEV_share_l1 | AGS + stateyear + year | 0 | state + year,
    data = merged
)

tsls_deaths_infants <- felm(
    deaths_infants_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1) | state + year,
    data = merged
)
```

```{r}
#| output: asis

htmlreg(
    list(
        "TWFE" = twfe_deaths_all,
        "1st Stage" = tsls_deaths_all$stage1,
        "2SLS" = tsls_deaths_all,
        "TWFE" = twfe_deaths_infants,
        "1st Stage" = tsls_deaths_infants$stage1,
        "2SLS" = tsls_deaths_infants
    ),
    custom.header = list(
        "All-Cause Mortality" = 1:3,
        "Infant Mortality" = 4:6
    ),
    caption = "Mortality Analysis: TWFE and 2SLS Results. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE,
    digits = 5
)
```

### Chained 2SLS: Mortality

```{r}
merged_chain_mortality <- merged %>%
    drop_na(
        deaths_all_per_1000, deaths_infants_per_1000, BEV_share_l1, PV_l1, gr_l2
    )

## 0th Stage

zeroth_stage_mortality <- felm(
    PV_l1 ~ gr_l2 | AGS + stateyear + year | 0 | state + year,
    data = merged_chain_mortality
)

merged_chain_mortality <- merged_chain_mortality %>%
    mutate(
        PV_l1_pred = zeroth_stage_mortality$fitted.values
    )

## 2SLS Chain - All-Cause Mortality

tsls_chain_deaths_all <- felm(
    deaths_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred) | state + year,
    data = merged_chain_mortality
)

tsls_chain_deaths_all_1quadratic <- felm(
    deaths_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred + I(PV_l1_pred^2)) | state + year,
    data = merged_chain_mortality
)

## 2SLS Chain - Infant Mortality

tsls_chain_deaths_infants <- felm(
    deaths_infants_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred) | state + year,
    data = merged_chain_mortality
)

tsls_chain_deaths_infants_1quadratic <- felm(
    deaths_infants_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred + I(PV_l1_pred^2)) | state + year,
    data = merged_chain_mortality
)

## 0th Stage with Quadratic

zeroth_stage_mortality_0quadratic <- felm(
    PV_l1 ~ gr_l2 + I(gr_l2^2) | AGS + stateyear + year | 0 | state + year,
    data = merged_chain_mortality
)

merged_chain_mortality <- merged_chain_mortality %>%
    mutate(
        PV_l1_pred_0quadratic = zeroth_stage_mortality_0quadratic$fitted.values
    )

tsls_chain_deaths_all_0quadratic <- felm(
    deaths_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic) | state + year,
    data = merged_chain_mortality
)

tsls_chain_deaths_all_0quadratic_1quadratic <- felm(
    deaths_all_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic + I(PV_l1_pred_0quadratic^2)) | state + year,
    data = merged_chain_mortality
)

tsls_chain_deaths_infants_0quadratic <- felm(
    deaths_infants_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic) | state + year,
    data = merged_chain_mortality
)

tsls_chain_deaths_infants_0quadratic_1quadratic <- felm(
    deaths_infants_per_1000 ~ 1 | AGS + stateyear + year | (BEV_share_l1 ~ PV_l1_pred_0quadratic + I(PV_l1_pred_0quadratic^2)) | state + year,
    data = merged_chain_mortality
)
```

```{r}
#| output: asis

htmlreg(
    list(
        "(1)" = zeroth_stage_mortality,
        "(2)" = zeroth_stage_mortality_0quadratic,
        "(1.1.1)" = tsls_chain_deaths_all,
        "(1.1.2)" = tsls_chain_deaths_all_1quadratic,
        "(2.1.1)" = tsls_chain_deaths_all_0quadratic,
        "(2.1.2)" = tsls_chain_deaths_all_0quadratic_1quadratic,
        "(1.2.1)" = tsls_chain_deaths_infants,
        "(1.2.2)" = tsls_chain_deaths_infants_1quadratic,
        "(2.2.1)" = tsls_chain_deaths_infants_0quadratic,
        "(2.2.2)" = tsls_chain_deaths_infants_0quadratic_1quadratic
    ),
    custom.header = list(
        "0-th Stage" = 1:2,
        "All-Cause Mortality 2SLS" = 3:6,
        "Infant Mortality 2SLS" = 7:10
    ),
    caption = "Chained 2SLS: Mortality Analysis. Fixed Effects: District (AGS), State×Year, Year. Clustering: State and Year.",
    caption.above = TRUE,
    custom.gof.rows = list(
        "Quadratic 0-th Stage" = c("", "✓", "", "", "✓", "✓", "", "", "✓", "✓"),
        "Quadratic 1st Stage" = c("", "", "", "✓", "", "✓", "", "✓", "", "✓")
    ),
    digits = 5,
    include.rsquared = FALSE,
    include.adjrs = FALSE,
    include.fstatistic = TRUE
)
```